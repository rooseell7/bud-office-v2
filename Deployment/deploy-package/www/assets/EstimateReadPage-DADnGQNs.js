import{u as as,a as rs,b as ns,r as x,e as os,h as $,i as q,j as s,B as t,c as v,A as M,T as e,k as T,M as W,P as is,f as n,d as G,m as ls,l as z}from"./index-D9d13f7b.js";import{W as I,w as cs}from"./worksSheetConfig-BsCs0GIO.js";function J(m){return m?(m.values??m.rawValues??[]).map(b=>[...b??[]]):[]}const ms=()=>{const{id:m}=as(),B=rs(),b=ns(),A=m?parseInt(m,10):NaN,l=Number.isFinite(A)&&A>0?A:null,[y,Q]=x.useState(null),[X,N]=x.useState(!0),[_,D]=x.useState(null),[V,Y]=x.useState({}),E=x.useCallback(()=>{const a=b.state?.from||"/estimate";window.location.href=a},[b.state]),Z=x.useCallback(()=>{window.print()},[]);if(x.useEffect(()=>{if(!l){N(!1);return}N(!0),D(null),os(l).then(async a=>{Q(a);const u=a.stages??[],o={};await Promise.all(u.map(async i=>{try{const[d,p]=await Promise.all([$(l,q(l,i.id,"works")),$(l,q(l,i.id,"materials"))]);o[i.id]={works:J(d?.snapshot),materials:J(p?.snapshot)}}catch{o[i.id]={works:[],materials:[]}}})),Y(o)}).catch(a=>{D(a?.response?.data?.message||"Помилка завантаження")}).finally(()=>N(!1))},[l]),!l)return s.jsxs(t,{className:"estimate-read noprint",children:[s.jsx(v,{startIcon:s.jsx(M,{}),onClick:()=>B("/estimate"),children:"Назад"}),s.jsx(e,{color:"error",sx:{mt:2},children:"Невірний ідентифікатор"})]});if(X&&!y)return s.jsx(t,{className:"estimate-read noprint",children:s.jsx(e,{children:"Завантаження…"})});if(_&&!y)return s.jsxs(t,{className:"estimate-read noprint",children:[s.jsx(v,{startIcon:s.jsx(M,{}),onClick:E,children:"Назад"}),s.jsx(e,{color:"error",sx:{mt:2},children:_})]});const S=y?.stages??[],h=S.reduce((a,u)=>{const o=V[u.id];if(!o)return a;const i=Math.max(o.works.length,1),d=Math.max(o.materials.length,1),p=T(o.works,i,I.TOTAL,I.COST_TOTAL,z),C=T(o.materials,d,W.TOTAL,W.COST_TOTAL,z);return a.worksSum+=p.sum,a.worksCost+=p.cost,a.materialsSum+=C.sum,a.materialsCost+=C.cost,a},{worksSum:0,worksCost:0,materialsSum:0,materialsCost:0}),w=h.worksSum+h.materialsSum,R=h.worksCost+h.materialsCost,H=w-R,ss=w>0?H/w*100:0;return s.jsxs(t,{className:"estimate-read",sx:{width:"100%",maxWidth:"100%"},children:[s.jsxs(t,{className:"noprint",sx:{display:"flex",alignItems:"center",gap:1,mb:2,flexWrap:"wrap"},children:[s.jsx(v,{size:"small",startIcon:s.jsx(M,{}),onClick:E,children:"Назад"}),s.jsxs(e,{variant:"h6",sx:{flex:1},children:[y?.title??`КП #${l}`," — режим читання"]}),s.jsx(v,{size:"small",startIcon:s.jsx(is,{}),variant:"contained",onClick:Z,children:"Друк"})]}),S.length>0&&s.jsxs(t,{className:"estimate-read-totals",sx:{display:"flex",flexWrap:"wrap",gap:2,p:1,mb:2,borderRadius:1,bgcolor:"action.hover",border:"1px solid",borderColor:"divider"},children:[s.jsx(e,{sx:{fontSize:12,fontWeight:600,color:"text.secondary",mr:1},children:"Загалом КП"}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Роботи:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:n(h.worksSum)})]}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Матеріали:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:n(h.materialsSum)})]}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Всього:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:n(w)})]}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Собівартість:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:n(R)})]}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Маржа:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:G(ss)})]}),s.jsxs(t,{sx:{display:"flex",gap:.5,alignItems:"baseline"},children:[s.jsx(e,{sx:{fontSize:11,color:"text.secondary"},children:"Прибуток:"}),s.jsx(e,{sx:{fontSize:13,fontWeight:600},children:n(H)})]})]}),S.length===0?s.jsx(e,{color:"text.secondary",children:"Немає етапів"}):S.map((a,u)=>{const o=V[a.id]??{works:[],materials:[]},i=o.works,d=o.materials,p=Math.max(i.length,1),C=Math.max(d.length,1),f=T(i,p,I.TOTAL,I.COST_TOTAL,z),g=T(d,C,W.TOTAL,W.COST_TOTAL,z),k=f.sum+g.sum,es=f.cost+g.cost,K=k-es,ts=k>0?K/k*100:0,O=[0,1,2,3,4,5,6,7,8],L=[0,1,2,3,4,5,6,7,8],F=cs.filter((c,r)=>O.includes(r)),U=ls.filter((c,r)=>L.includes(r));return s.jsxs(t,{className:"estimate-read-stage",sx:{breakInside:"avoid",pageBreakInside:"avoid",mb:3,pb:2,borderBottom:"1px solid",borderColor:"divider"},children:[s.jsxs(e,{variant:"h6",sx:{mb:1.5,pb:.5,borderBottom:"1px solid",borderColor:"divider",fontWeight:600},children:["Етап ",u+1,": ",a.name]}),s.jsxs(t,{sx:{mb:2},children:[s.jsx(e,{variant:"subtitle2",sx:{mb:.5,fontWeight:600},children:"Роботи"}),s.jsxs(t,{component:"table",sx:{width:"100%",borderCollapse:"collapse",fontSize:13,"& th, & td":{border:"1px solid",borderColor:"divider",px:1,py:.5},"& th":{bgcolor:"action.hover",fontWeight:600,textAlign:"left"},"& td":{verticalAlign:"top"},"& .num":{textAlign:"right",fontVariantNumeric:"tabular-nums"}},children:[s.jsx("thead",{children:s.jsx("tr",{children:F.map((c,r)=>s.jsx("th",{className:[4,5,6,7].includes(O[r])?"num":"",children:c},r))})}),s.jsx("tbody",{children:i.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:F.length,children:"—"})}):i.map((c,r)=>s.jsx("tr",{children:O.map((j,P)=>s.jsx("td",{className:[4,5,6,7].includes(j)?"num":"",children:c[j]??"—"},P))},r))})]}),s.jsx(t,{sx:{display:"flex",justifyContent:"flex-end",mt:.5,py:.75,px:1,bgcolor:"action.hover",borderRadius:.5,fontSize:12},children:s.jsxs("span",{children:["Разом: ",n(f.sum)," · Собівартість:"," ",n(f.cost)," · Прибуток: ",n(f.profit)]})})]}),s.jsxs(t,{children:[s.jsx(e,{variant:"subtitle2",sx:{mb:.5,fontWeight:600},children:"Матеріали"}),s.jsxs(t,{component:"table",sx:{width:"100%",borderCollapse:"collapse",fontSize:13,"& th, & td":{border:"1px solid",borderColor:"divider",px:1,py:.5},"& th":{bgcolor:"action.hover",fontWeight:600,textAlign:"left"},"& td":{verticalAlign:"top"},"& .num":{textAlign:"right",fontVariantNumeric:"tabular-nums"}},children:[s.jsx("thead",{children:s.jsx("tr",{children:U.map((c,r)=>s.jsx("th",{className:[4,5,6,7].includes(L[r])?"num":"",children:c},r))})}),s.jsx("tbody",{children:d.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:U.length,children:"—"})}):d.map((c,r)=>s.jsx("tr",{children:L.map((j,P)=>s.jsx("td",{className:[4,5,6,7].includes(j)?"num":"",children:c[j]??"—"},P))},r))})]}),s.jsx(t,{sx:{display:"flex",justifyContent:"flex-end",mt:.5,py:.75,px:1,bgcolor:"action.hover",borderRadius:.5,fontSize:12},children:s.jsxs("span",{children:["Разом: ",n(g.sum)," · Собівартість:"," ",n(g.cost)," · Прибуток:"," ",n(g.profit)]})})]}),s.jsx(t,{sx:{display:"flex",justifyContent:"flex-end",mt:1,py:.5,fontSize:12,color:"text.secondary"},children:s.jsxs("span",{children:["Етап: ",n(k)," · Маржа ",G(ts)," · Прибуток"," ",n(K)]})})]},a.id)}),s.jsx("style",{children:`
        @media print {
          body * { visibility: hidden; }
          .estimate-read, .estimate-read * { visibility: visible; }
          .estimate-read { position: absolute; left: 0; top: 0; width: 100%; padding: 0; }
          .noprint { display: none !important; }
          .estimate-read-stage { break-inside: avoid; page-break-inside: avoid; }
          .boHeader, .boSidebar, [class*="AppBar"], [class*="Drawer"] { display: none !important; }
        }
      `})]})};export{ms as EstimateReadPage};
//# sourceMappingURL=EstimateReadPage-DADnGQNs.js.map
