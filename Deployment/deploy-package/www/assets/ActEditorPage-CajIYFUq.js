import{r as l,g as K,n as de,u as ue,a as pe,b as xe,o as fe,p as J,q as L,j as e,B as m,c as M,A as O,T as x,C as G,s as Q,F as X,S as Y,f as k,d as he,R as P,t as me}from"./index-D8VVMNMM.js";import{A as ye,a as Se,E as ge,b as we,c as je}from"./ExpandLess-DeuXO4F9.js";import{W as w,a as Ce}from"./worksSheetConfig-Cldzvhky.js";function b(s){if(s==null)return 0;const o=Number(s);return Number.isFinite(o)?o:0}function Z(s,o){const i=[];for(const n of s)(n?.rowType??n?.type)==="work"&&(n?.sectionKey===o||!o)&&i.push(n);return i}const Te=20;function ee(s){const o=Math.max(s.length,Te),i=9,n=[];for(let r=0;r<o;r++){const a=s[r];n[r]=["",String(a?.name??a?.title??""),String(a?.unit??""),String(b(a?.qty)),String(b(a?.price)),"",String(b(a?.costPrice??a?.cost)),"",String(a?.note??"")]}return{rawValues:n,values:n.map(r=>[...r]),rowCount:o,colCount:i}}function ke(s,o){const i=s.rawValues??s.values??[],n=[];for(const r of i){if(!r)continue;const a=String(r[w.NAME]??"").trim(),t=String(r[w.UNIT]??"").trim(),u=b(r[w.QTY]),S=b(r[w.PRICE]),p=b(r[w.COST_UNIT]),y=String(r[w.NOTE]??"").trim();!a&&!t&&u===0&&S===0||n.push({rowType:"work",type:"work",sectionKey:o,name:a||"",unit:t||"",qty:u,price:S,costPrice:p,note:y||void 0})}return n.length===0&&n.push({rowType:"work",type:"work",sectionKey:o,name:"",unit:"",qty:0,price:0,costPrice:0}),n}function be(s,o,i){const n=[];let r=!1;for(const t of s){const u=t?.rowType??t?.type,S=t?.sectionKey;if(u==="meta"){n.push(t),r=!1;continue}if(u==="section"){r=S===o,n.push(t),r&&n.push(...i);continue}r&&S===o&&u==="work"||n.push(t)}return s.some(t=>(t?.rowType??t?.type)==="section"&&t?.sectionKey===o)||n.push({rowType:"section",type:"section",sectionKey:o,title:"Роботи"},...i),n}function Ae(s,o,i,n){const[r,a]=l.useState("loading"),[t,u]=l.useState(null);return l.useEffect(()=>{if(!s||!o){a("edit"),u(null);return}const p=Z(i,o);u(ee(p)),a("edit")},[s,o,JSON.stringify(i.map(p=>({sk:p?.sectionKey,t:p?.rowType??p?.type})))]),{adapter:{getDraftKey:()=>s&&o?`act:${s}:${o}`:null,loadSnapshot:async()=>{if(!s)return null;const p=await K(s),y=Z(p.items??[],o);return{snapshot:ee(y),revision:0}},saveSnapshot:async p=>{if(!s||!o)throw new Error("No act or sectionKey");const y=await K(s),A=y.items??[],j=ke(p,o),g=be(A,o,j).map(C=>{const d={...C};return typeof d.rowType=="string"&&(d.type=d.rowType),d.rowType==="work"&&(d.title=d.name,d.cost=d.costPrice),d.rowType==="percent"&&(d.title=d.name,d.percent=d.percentValue),d});return await de(s,{projectId:y.projectId,foremanId:y.foremanId,actDate:y.actDate,status:y.status,items:g}),n?.(),{revision:0}}},mode:r,initialSnapshot:t}}const Ie=!0,te=s=>`act:${s}:hideCost`,D=s=>`act:${s}:expandedSections`;function ve(s){const i=[...Array.isArray(s)?s:[]];i.some(t=>t?.rowType==="meta"||t?.type==="meta")||i.unshift({rowType:"meta",type:"meta",header:{}});const r=i.some(t=>t?.rowType==="section"||t?.type==="section"),a=i.some(t=>t?.rowType==="work"||t?.type==="work");return r||i.push({rowType:"section",type:"section",sectionKey:"sec_1",title:"Роботи"}),a||i.push({rowType:"work",type:"work",sectionKey:"sec_1",name:"",unit:"",qty:0,price:0,costPrice:0}),i}function se(s){const o=new Set,i=[];for(const n of s)(n?.rowType??n?.type)==="section"&&n?.sectionKey&&!o.has(n.sectionKey)&&(o.add(n.sectionKey),i.push({sectionKey:n.sectionKey,title:String(n?.title??"Роботи")}));return i.length===0&&i.push({sectionKey:"sec_1",title:"Роботи"}),i}const Me=()=>{const{id:s}=ue(),o=pe(),i=xe(),n=l.useCallback(()=>{const c=i.state?.from||"/estimate/acts";window.location.href=c},[i.state]),{can:r}=fe(),a=s?parseInt(s,10):NaN,t=Number.isFinite(a)&&a>0?a:null,[u,S]=l.useState(null),[p,y]=l.useState([]),[A,j]=l.useState(!0),[I,g]=l.useState(null),[C,d]=l.useState(!1),[z,v]=l.useState(()=>new Set),[R,oe]=l.useState(!1),[F,ne]=l.useState({}),B=r("delivery:write")||r("estimates:write");l.useEffect(()=>{t&&d(J(te(t),!1))},[t]);const re=l.useCallback(c=>{d(c),t&&L(te(t),c)},[t]),W=l.useCallback(async()=>{if(t){j(!0),g(null);try{const c=await K(t);S(c);const h=ve(c.items);y(h);const f=se(h);v(H=>{const V=J(D(t),[]).filter(T=>f.some(E=>E.sectionKey===T));if(V.length>0)return new Set(V);if(H.size>0){const T=[...H].filter(E=>f.some(le=>le.sectionKey===E));return T.length>0?new Set(T):new Set(f.map(E=>E.sectionKey))}return new Set(f.slice(0,1).map(T=>T.sectionKey))})}catch(c){g(c?.message||"Помилка завантаження")}finally{j(!1)}}},[t]);l.useEffect(()=>{if(!t){j(!1);return}W()},[t,W]);const ie=l.useCallback(c=>{v(h=>{const f=new Set(h);return f.add(c),t&&L(D(t),[...f]),f})},[t]),ce=l.useCallback(c=>{v(h=>{const f=new Set(h);return f.delete(c),t&&L(D(t),[...f]),f})},[t]),U=l.useMemo(()=>se(p),[p]),_=l.useMemo(()=>{let c=0,h=0;for(const f of Object.values(F))c+=f.sum,h+=f.cost;return{worksSum:c,worksCost:h}},[F]);if(!t)return e.jsxs(m,{children:[e.jsx(M,{startIcon:e.jsx(O,{}),onClick:()=>o("/estimate/acts"),children:"Назад"}),e.jsx(x,{color:"error",sx:{mt:2},children:"Невірний ідентифікатор"})]});if(A&&!u)return e.jsx(m,{children:e.jsx(x,{children:"Завантаження…"})});if(I&&!u)return e.jsxs(m,{children:[e.jsx(M,{startIcon:e.jsx(O,{}),onClick:n,children:"Назад"}),e.jsx(x,{color:"error",sx:{mt:2},children:I})]});if(!u)return null;const N=_.worksSum,q=_.worksCost,$=N-q,ae=N>0?$/N*100:0;return e.jsxs(m,{className:"act-editor-full",sx:{width:"100%",maxWidth:"100%"},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5,flexWrap:"wrap"},children:[e.jsx(M,{size:"small",startIcon:e.jsx(O,{}),onClick:n,children:"Назад"}),e.jsxs(x,{variant:"h6",sx:{flex:1},children:["Акт №",u.id]}),e.jsx(G,{size:"small",label:`Дата: ${u.actDate}`}),e.jsx(G,{size:"small",label:u.status}),B&&e.jsx(Q,{title:"Режим тільки перегляд",children:e.jsx(X,{control:e.jsx(Y,{size:"small",checked:R,onChange:(c,h)=>oe(h),color:"primary"}),label:e.jsx(x,{sx:{fontSize:12},children:"Тільки перегляд"})})}),e.jsx(Q,{title:"Приховати колонки собівартості",children:e.jsx(X,{control:e.jsx(Y,{size:"small",checked:C,onChange:(c,h)=>re(h),color:"primary"}),label:e.jsx(x,{sx:{fontSize:12},children:"Приховати собівартість"})})})]}),e.jsxs(m,{sx:{display:"flex",flexWrap:"wrap",gap:2,p:.75,mb:1,borderRadius:1,bgcolor:"action.hover",border:"1px solid",borderColor:"divider",alignItems:"center"},children:[e.jsx(x,{sx:{fontSize:11,fontWeight:600,color:"text.secondary",mr:.5},children:"Загалом по акту"}),e.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[e.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Роботи:"}),e.jsx(x,{sx:{fontSize:13,fontWeight:600},children:k(_.worksSum)})]}),!C&&e.jsxs(e.Fragment,{children:[e.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[e.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Собівартість:"}),e.jsx(x,{sx:{fontSize:13,fontWeight:600},children:k(q)})]}),e.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[e.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Маржа:"}),e.jsx(x,{sx:{fontSize:13,fontWeight:600},children:he(ae)})]}),e.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[e.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Прибуток:"}),e.jsx(x,{sx:{fontSize:13,fontWeight:600},children:k($)})]})]})]}),e.jsx(x,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Секції (роботи)"}),U.length===0?e.jsx(x,{color:"text.secondary",children:"Немає секцій"}):U.map(c=>e.jsx(Ee,{section:c,actId:t,items:p,onItemsRefresh:()=>W(),expanded:z.has(c.sectionKey),onExpand:()=>ie(c.sectionKey),onCollapse:()=>ce(c.sectionKey),canEdit:!R&&B,hideCost:C,onTotalsChange:h=>ne(f=>({...f,[c.sectionKey]:h}))},c.sectionKey))]})};function Ee({section:s,actId:o,items:i,onItemsRefresh:n,expanded:r,onExpand:a,onCollapse:t,canEdit:u,hideCost:S,onTotalsChange:p}){const A={...{...Ce,allowColumnInsert:Ie,allowColumnDelete:!1,allowColumnRename:!1},autocompleteForColumn:{colIndex:1,type:"works"},hiddenColumns:S?[6,7]:void 0,allowCellComments:!0,allowFreeze:!0},{adapter:j,initialSnapshot:I}=Ae(o,s.sectionKey,i,n??void 0),[g,C]=P.useState({sum:0,cost:0,profit:0});P.useEffect(()=>{p(g)},[g,p]);const d=P.useCallback(z=>{C(z)},[]);return e.jsxs(ye,{expanded:r,onChange:(z,v)=>v?a():t(),sx:{"&:before":{display:"none"},boxShadow:0,border:"1px solid",borderColor:"divider",mb:.5},children:[e.jsx(Se,{expandIcon:r?e.jsx(ge,{}):e.jsx(we,{}),sx:{minHeight:44,"& .MuiAccordionSummary-content":{my:.5}},children:e.jsx(x,{variant:"body2",fontWeight:600,children:s.title})}),e.jsx(je,{sx:{pt:0,px:0},children:e.jsxs(m,{sx:{pt:.5,position:"relative"},children:[e.jsx(me,{config:A,adapter:j??void 0,documentId:null,initialSnapshot:I,readonly:!u,totalsConfig:{sumCol:w.TOTAL,costCol:w.COST_TOTAL},onTotalsChange:d}),e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:.5},children:e.jsx(ze,{totals:g,hideCost:S})})]})})]})}function ze({totals:s,hideCost:o}){return e.jsx(m,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:.25,px:1.5,py:.75,fontSize:12,bgcolor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider"},children:o?e.jsxs("span",{children:[e.jsx("span",{style:{color:"var(--mui-palette-text-secondary)"},children:"Роботи:"})," ",e.jsx("strong",{children:k(s.sum)})]}):e.jsx(e.Fragment,{children:e.jsxs("span",{children:[e.jsx("span",{style:{color:"var(--mui-palette-text-secondary)"},children:"Роботи:"})," ",e.jsxs("strong",{children:[k(s.sum)," / соб. ",k(s.cost)]})]})})})}export{Me as ActEditorPage};
//# sourceMappingURL=ActEditorPage-CajIYFUq.js.map
