const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D8VVMNMM.js","assets/index-boXsqFrX.css"])))=>i.map(i=>d[i]);
import{r as a,h as ge,v as $e,D as Q,u as Pe,a as Fe,b as Me,o as Ne,p as ee,q as D,e as He,w as Ue,x as Ve,y as Xe,z as Ge,j as e,B as x,c as y,A as te,T as f,s as J,F as se,S as ne,E as Je,I as Y,H as qe,f as u,d as Ie,G as pe,J as Se,K as je,L as be,N as Qe,O as Ce,_ as Ye,Q as Ze,i as Ke,R as q,U as et,V as tt,W as st,X as nt,Y as ye,t as at,M as we,Z as ot,$ as lt,a0 as rt,a1 as it}from"./index-D8VVMNMM.js";import{C as ct,A as dt,a as ut,E as xt,b as mt,c as ht}from"./ExpandLess-DeuXO4F9.js";import{W as ve,a as ft}from"./worksSheetConfig-Cldzvhky.js";function gt(r,i){const[m,c]=a.useState("loading"),[b,g]=a.useState(null);return a.useEffect(()=>{if(!r||!i){c("edit"),g(null);return}let o=!0;return(async()=>{try{const{snapshot:S}=await ge(r,i);o&&S&&g(S),o&&c("edit")}catch{o&&c("edit"),g(null)}})(),()=>{o=!1}},[r,i]),{adapter:{getDraftKey:()=>i?`stage:${i}`:null,loadSnapshot:async()=>{if(!r||!i)return null;const{snapshot:o,revision:S}=await ge(r,i);return{snapshot:o,revision:S}},saveSnapshot:async(o,S)=>{if(!r||!i)throw new Error("No estimate or docKey");try{const{revision:C}=await $e(r,i,o,S);return{revision:C}}catch(C){throw C?.response?.status===409?new Error("CONFLICT"):C}}},mode:m,initialSnapshot:b}}function pt(){if(!Q)return()=>{};const r=(c,b)=>{const g=(c.composedPath?.()||[]).slice(0,6).map(s=>s?.tagName||s?.nodeName).join(">");console.log(`[${b}] ${c.type}`,{target:c.target?.tagName,defaultPrevented:c.defaultPrevented,cancelBubble:c.cancelBubble,path:g})},i=c=>r(c,"CAPTURE"),m=c=>r(c,"BUBBLE");return document.addEventListener("click",i,!0),document.addEventListener("click",m,!1),document.addEventListener("pointerdown",i,!0),document.addEventListener("pointerdown",m,!1),console.log("[dbg] click debug ON"),()=>{document.removeEventListener("click",i,!0),document.removeEventListener("click",m,!1),document.removeEventListener("pointerdown",i,!0),document.removeEventListener("pointerdown",m,!1),console.log("[dbg] click debug OFF")}}const St=25e3,jt=!0,ke=r=>`estimate:${r}:focusMode`,z=r=>`estimate:${r}:expandedStages`,Ee=r=>`estimate:${r}:hideCost`,kt=()=>{const{id:r}=Pe(),i=Fe(),m=Me();a.useEffect(()=>{if(Q)return console.log("[EDIT] mount"),()=>console.log("[EDIT] unmount")},[]),a.useEffect(()=>{Q&&console.log("[EDIT] location:",m.pathname,"key:",m.key)},[m.pathname,m.key]),a.useEffect(()=>{if(!Q)return;const t=pt();return()=>t()},[]);const c=()=>{const t=m.state?.from||"/estimate";window.location.href=t},{can:b}=Ne(),g=r?parseInt(r,10):NaN,s=Number.isFinite(g)&&g>0?g:null,[o,S]=a.useState(null),[C,R]=a.useState(!0),[U,V]=a.useState(null),[L,O]=a.useState(!0),[v,k]=a.useState(()=>new Set),[B,ae]=a.useState(!1),[W,X]=a.useState(!1);a.useEffect(()=>{s&&(O(ee(ke(s),!0)),X(ee(Ee(s),!1)))},[s]);const Z=a.useCallback(t=>{O(t),s&&D(ke(s),t)},[s]),$=a.useCallback(t=>{X(t),s&&D(Ee(s),t)},[s]),[K,E]=a.useState({}),[P,w]=a.useState(null),[h,A]=a.useState(""),[G,F]=a.useState(null),[oe,le]=a.useState(!1),[De,re]=a.useState(null),[ie,ce]=a.useState(!1),[M,Le]=a.useState(!1),[de,ue]=a.useState([]),xe=a.useRef({}),[Ae,Te]=a.useState({}),I=b("estimates:write")||b("documents:write")||b("sheet:write"),_e=I,T=a.useCallback(async()=>{if(s){R(!0),V(null);try{const t=await He(s);S(t);const n=new Set(t.stages.map(l=>l.id));k(l=>{const _=ee(z(s),[]).filter(j=>n.has(j));let d;if(_.length>0)d=new Set(_);else if(l.size>0){const j=[...l].filter(N=>n.has(N));d=j.length>0?new Set(j):new Set(t.stages.length>0?[t.stages[0].id]:[])}else d=t.stages.length>0?new Set([t.stages[0].id]):new Set;return s&&d.size>0&&D(z(s),[...d]),d})}catch(t){V(t?.response?.data?.message||"Помилка завантаження")}finally{R(!1)}}},[s]);a.useEffect(()=>{if(!s){R(!1);return}T()},[s,T]),a.useEffect(()=>{if(!s||!I)return;let t=null;Ue(s).then(p=>{t=p.token}).catch(()=>{});const l=setInterval(()=>{t&&Ye(async()=>{const{heartbeatEditSession:p}=await import("./index-D8VVMNMM.js").then(_=>_.ao);return{heartbeatEditSession:p}},__vite__mapDeps([0,1])).then(({heartbeatEditSession:p})=>p(s,t).catch(()=>{}))},St);return()=>{clearInterval(l),t&&Ve(s,t).catch(()=>{})}},[s,I]);const me=async()=>{if(s){le(!0);try{const t=await Ze(s,{name:`Етап ${(o?.stages?.length??0)+1}`});await T(),k(n=>{const l=L?new Set([t.id]):new Set([...n,t.id]);return s&&D(z(s),[...l]),l}),E(n=>({...n,[t.id]:0}))}finally{le(!1)}}},ze=a.useCallback(t=>{k(n=>{const l=L?new Set([t]):new Set([...n,t]);return s&&D(z(s),[...l]),l})},[L,s]),Re=a.useCallback(t=>{k(n=>{const l=new Set(n);return l.delete(t),s&&D(z(s),[...l]),l})},[s]),he=async()=>{if(!s||!P||!h.trim()){w(null);return}try{await rt(s,P,{name:h.trim()}),await T()}finally{w(null)}},Oe=async t=>{if(s){re(t);try{const n=await lt(s,t);await T(),k(l=>{const p=new Set(l);return p.add(n.id),s&&D(z(s),[...p]),p}),E(l=>({...l,[n.id]:0}))}catch{}finally{re(null)}}},fe=a.useCallback(async()=>{if(s)try{const t=await Xe(s,20);ue(t)}catch{ue([])}},[s]);a.useEffect(()=>{M&&s&&fe()},[M,s,fe]);const Be=a.useCallback(async()=>{if(s){ce(!0);try{const t=await Ge(s),n=URL.createObjectURL(t),l=document.createElement("a");l.href=n,l.download=`КП-${s}.xlsx`,l.click(),URL.revokeObjectURL(n)}finally{ce(!1)}}},[s]),We=async()=>{if(!(!s||!G))try{await it(s,G.id),await T(),F(null)}finally{F(null)}};return s?C&&!o?e.jsx(x,{children:e.jsx(f,{children:"Завантаження…"})}):U&&!o?e.jsxs(x,{children:[e.jsx(y,{startIcon:e.jsx(te,{}),onClick:c,children:"Назад"}),e.jsx(f,{color:"error",sx:{mt:2},children:U})]}):e.jsxs(x,{className:"estimate-editor-full",sx:{width:"100%",maxWidth:"100%"},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5,flexWrap:"wrap"},children:[e.jsx(y,{size:"small",startIcon:e.jsx(te,{}),onClick:c,children:"Назад"}),e.jsx(f,{variant:"h6",sx:{flex:1},children:o?.title??`КП #${s}`}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:.5,flexWrap:"wrap"},children:[I&&e.jsx(J,{title:"Режим тільки перегляд — без редагування",children:e.jsx(se,{control:e.jsx(ne,{size:"small",checked:B,onChange:(t,n)=>ae(n),color:"primary"}),label:e.jsx(f,{sx:{fontSize:12},children:"Тільки перегляд"})})}),e.jsx(J,{title:"Приховати колонки собівартості",children:e.jsx(se,{control:e.jsx(ne,{size:"small",checked:W,onChange:(t,n)=>$(n),color:"primary"}),label:e.jsx(f,{sx:{fontSize:12},children:"Приховати собівартість"})})}),o?.stages&&o.stages.length>0&&e.jsx(J,{title:"При відкритті етапу інші згортаються",children:e.jsx(se,{control:e.jsx(ne,{size:"small",checked:L,onChange:(t,n)=>Z(n),color:"primary"}),label:e.jsx(f,{sx:{fontSize:12},children:"Фокус етапу"})})})]}),e.jsx(y,{size:"small",startIcon:e.jsx(Je,{}),onClick:Be,disabled:ie||!o?.stages?.length,children:ie?"…":"Експорт XLSX"}),e.jsx(J,{title:M?"Згорнути історію":"Історія змін",children:e.jsx(Y,{size:"small",onClick:()=>Le(t=>!t),color:M?"primary":"default",children:e.jsx(qe,{fontSize:"small"})})})]}),e.jsx(ct,{in:M,children:e.jsxs(x,{sx:{mb:2,p:1.5,bgcolor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"caption",fontWeight:600,color:"text.secondary",sx:{display:"block",mb:1},children:"Останні зміни"}),de.length===0?e.jsx(f,{variant:"body2",color:"text.secondary",children:"Історія змін поки відсутня"}):e.jsx(x,{component:"ul",sx:{m:0,pl:2.5,fontSize:13},children:de.map(t=>e.jsxs("li",{children:[t.kind==="version"?"Версія":"Оновлення"," #",t.id," ·"," ",t.createdAt?new Date(t.createdAt).toLocaleString("uk-UA"):"",t.note?` · ${t.note}`:""]},`${t.kind}-${t.id}`))})]})}),o?.stages&&o.stages.length>0&&(()=>{const t=o.stages.reduce((j,N)=>{const H=Ae[N.id];return H&&(j.worksSum+=H.works.sum,j.worksCost+=H.works.cost,j.materialsSum+=H.materials.sum,j.materialsCost+=H.materials.cost),j},{worksSum:0,worksCost:0,materialsSum:0,materialsCost:0}),n=t.worksSum+t.materialsSum,l=t.worksCost+t.materialsCost,p=n-l,_=n>0?p/n*100:0,d=({label:j,value:N})=>e.jsxs(x,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[e.jsxs(f,{sx:{fontSize:11,color:"text.secondary"},children:[j,":"]}),e.jsx(f,{sx:{fontSize:13,fontWeight:600},children:N})]});return e.jsxs(x,{sx:{display:"flex",flexDirection:"row",flexWrap:"wrap",gap:2,p:.75,mb:1,borderRadius:1,bgcolor:"action.hover",border:"1px solid",borderColor:"divider",alignItems:"center"},children:[e.jsx(f,{sx:{fontSize:11,fontWeight:600,color:"text.secondary",mr:.5},children:"Загалом КП"}),W?e.jsxs(e.Fragment,{children:[e.jsx(d,{label:"Сума в роботах",value:u(t.worksSum)}),e.jsx(d,{label:"Сума в матеріалах",value:u(t.materialsSum)}),e.jsx(d,{label:"Всього",value:u(n)})]}):e.jsxs(e.Fragment,{children:[e.jsx(d,{label:"Роботи: сума",value:u(t.worksSum)}),e.jsx(d,{label:"Роботи: собівартість",value:u(t.worksCost)}),e.jsx(d,{label:"Роботи: прибуток",value:u(t.worksSum-t.worksCost)}),e.jsx(d,{label:"Матеріали: сума",value:u(t.materialsSum)}),e.jsx(d,{label:"Матеріали: собівартість",value:u(t.materialsCost)}),e.jsx(d,{label:"Матеріали: прибуток",value:u(t.materialsSum-t.materialsCost)}),e.jsx(d,{label:"Всього: сума",value:u(n)}),e.jsx(d,{label:"Всього: собівартість",value:u(l)}),e.jsx(d,{label:"Маржа",value:Ie(_)}),e.jsx(d,{label:"Прибуток",value:u(p)})]})]})})(),e.jsxs(x,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:1,mb:1},children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",sx:{mr:1},children:"Етапи"}),I&&!B&&e.jsx(y,{size:"small",startIcon:e.jsx(pe,{}),onClick:me,disabled:oe,children:"Додати етап"})]}),o?.stages?.length===0?e.jsxs(x,{sx:{py:3,textAlign:"center"},children:[e.jsx(f,{color:"text.secondary",sx:{mb:2},children:"Немає етапів. Додайте перший етап."}),I&&e.jsx(y,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:me,disabled:oe,children:"Додати етап"})]}):o?.stages?.map(t=>e.jsx(x,{ref:n=>{n?xe.current[t.id]=n:delete xe.current[t.id]},children:e.jsx(Ct,{stage:t,estimateId:s,expanded:v.has(t.id),onExpand:()=>ze(t.id),onCollapse:()=>Re(t.id),activeTab:K[t.id]??0,onTabChange:n=>E(l=>({...l,[t.id]:n})),canEdit:!B&&I,canDelete:_e&&!B,hideCost:W,onRenameClick:()=>{w(t.id),A(t.name)},onDuplicateClick:()=>Oe(t.id),isDuplicating:De===t.id,onDeleteClick:()=>F(t),onTotalsChange:(n,l)=>Te(p=>({...p,[t.id]:{works:n,materials:l}}))})},t.id)),e.jsxs(Se,{open:!!P,onClose:()=>w(null),children:[e.jsx(je,{children:"Перейменувати етап"}),e.jsx(be,{children:e.jsx(Qe,{autoFocus:!0,fullWidth:!0,value:h,onChange:t=>A(t.target.value),onKeyDown:t=>{t.key==="Enter"&&he(),t.key==="Escape"&&w(null)}})}),e.jsxs(Ce,{children:[e.jsx(y,{onClick:()=>w(null),children:"Скасувати"}),e.jsx(y,{variant:"contained",onClick:he,disabled:!h.trim(),children:"Зберегти"})]})]}),e.jsxs(Se,{open:!!G,onClose:()=>F(null),children:[e.jsx(je,{children:"Видалити етап"}),e.jsx(be,{children:e.jsxs(f,{children:['Видалити етап "',G?.name,'"? Дані робіт і матеріалів будуть втрачені.']})}),e.jsxs(Ce,{children:[e.jsx(y,{onClick:()=>F(null),children:"Скасувати"}),e.jsx(y,{color:"error",variant:"contained",onClick:We,children:"Видалити"})]})]})]}):e.jsxs(x,{children:[e.jsx(y,{startIcon:e.jsx(te,{}),onClick:()=>i("/estimate"),children:"Назад"}),e.jsx(f,{color:"error",sx:{mt:2},children:"Невірний ідентифікатор"})]})};function bt({worksTotals:r,materialsTotals:i,hideCost:m=!1}){const c=r.sum+i.sum,b=r.cost+i.cost,g=c-b,s=c>0?g/c*100:0,o=({label:S,value:C})=>e.jsxs(x,{sx:{display:"flex",gap:.5,fontSize:12},children:[e.jsxs("span",{style:{color:"var(--mui-palette-text-secondary)"},children:[S,":"]}),e.jsx("span",{style:{fontWeight:600},children:C})]});return e.jsx(x,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:.25,px:1.5,py:.75,fontSize:12,bgcolor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider"},children:m?e.jsxs(e.Fragment,{children:[e.jsx(o,{label:"Роботи",value:u(r.sum)}),e.jsx(o,{label:"Матеріали",value:u(i.sum)}),e.jsx(o,{label:"Етап",value:u(c)})]}):e.jsxs(e.Fragment,{children:[e.jsx(o,{label:"Роботи",value:`${u(r.sum)} / соб. ${u(r.cost)}`}),e.jsx(o,{label:"Матеріали",value:`${u(i.sum)} / соб. ${u(i.cost)}`}),e.jsx(o,{label:"Етап",value:`${u(c)} · маржа ${Ie(s)}`})]})})}function Ct({stage:r,estimateId:i,expanded:m,onExpand:c,onCollapse:b,activeTab:g,onTabChange:s,canEdit:o,canDelete:S,hideCost:C,onRenameClick:R,onDuplicateClick:U,isDuplicating:V=!1,onDeleteClick:L,onTotalsChange:O}){const v=g===0?"works":"materials",k=Ke(i,r.id,v),W={...{...g===0?ft:ot,allowColumnInsert:jt,allowColumnDelete:!1,allowColumnRename:!1},autocompleteForColumn:{colIndex:1,type:v},hiddenColumns:C?[6,7]:void 0,allowCellComments:!0,allowFreeze:!0},{adapter:X,initialSnapshot:Z}=gt(i,k),[$,K]=q.useState({sum:0,cost:0,profit:0}),[E,P]=q.useState({sum:0,cost:0,profit:0});q.useEffect(()=>{O?.($,E)},[$,E,O]);const w=q.useCallback(h=>{v==="works"?K(h):P(h)},[v]);return e.jsxs(dt,{expanded:m,onChange:(h,A)=>A?c():b(),sx:{"&:before":{display:"none"},boxShadow:0,border:"1px solid",borderColor:"divider",mb:.5},children:[e.jsx(ut,{expandIcon:m?e.jsx(xt,{}):e.jsx(mt,{}),sx:{minHeight:44,"& .MuiAccordionSummary-content":{my:.5}},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},onClick:h=>h.stopPropagation(),children:[e.jsx(f,{variant:"body2",fontWeight:600,children:r.name}),o&&e.jsx(Y,{size:"small",onClick:h=>{h.stopPropagation(),R()},"aria-label":"Перейменувати",children:e.jsx(et,{fontSize:"small"})}),o&&e.jsx(Y,{size:"small",onClick:h=>{h.stopPropagation(),U()},"aria-label":"Дублювати",disabled:V,children:e.jsx(tt,{fontSize:"small"})}),S&&e.jsx(Y,{size:"small",color:"error",onClick:h=>{h.stopPropagation(),L()},"aria-label":"Видалити",children:e.jsx(st,{fontSize:"small"})})]})}),e.jsxs(ht,{sx:{pt:0,px:0},children:[e.jsxs(nt,{value:g,onChange:(h,A)=>s(A),sx:{minHeight:36,borderBottom:1,borderColor:"divider",px:1},children:[e.jsx(ye,{label:"Роботи",sx:{minHeight:36,py:.5}}),e.jsx(ye,{label:"Матеріали",sx:{minHeight:36,py:.5}})]}),e.jsxs(x,{sx:{pt:.5,position:"relative"},children:[e.jsx(at,{config:W,adapter:X??void 0,documentId:null,initialSnapshot:Z,readonly:!o,totalsConfig:v==="works"?{sumCol:ve.TOTAL,costCol:ve.COST_TOTAL}:{sumCol:we.TOTAL,costCol:we.COST_TOTAL},onTotalsChange:w}),e.jsx(x,{sx:{display:"flex",justifyContent:"flex-end",mt:.5},children:e.jsx(bt,{worksTotals:$,materialsTotals:E,hideCost:C})})]})]})]})}export{kt as EstimateEditorPage};
//# sourceMappingURL=EstimateEditorPage-BCFCKBRp.js.map
