{"version":3,"mappings":"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","names":["useStageSheetAdapter","estimateId","docKey","mode","setMode","useState","initialSnapshot","setInitialSnapshot","useEffect","mounted","snapshot","getSheetByDocKey","revision","expectedRevision","saveSheetByDocKey","e","enableClickDebug","DEBUG_NAV","mark","phase","path","n","cap","bub","HEARTBEAT_INTERVAL_MS","ESTIMATE_ALLOW_COLUMN_INSERT","LS_FOCUS_MODE","LS_EXPANDED_STAGES","LS_HIDE_COST","EstimateEditorPage","id","useParams","navigate","useNavigate","loc","useLocation","off","goBack","target","can","useAuth","validId","doc","setDoc","loading","setLoading","error","setError","focusMode","setFocusModeState","expandedStages","setExpandedStages","viewMode","setViewMode","hideCost","setHideCostState","lsGetJson","setFocusMode","useCallback","v","lsSetJson","setHideCost","activeTabByStage","setActiveTabByStage","renameStageId","setRenameStageId","renameValue","setRenameValue","deleteConfirmStage","setDeleteConfirmStage","addingStage","setAddingStage","duplicatingStageId","setDuplicatingStageId","exporting","setExporting","historyOpen","setHistoryOpen","history","setHistory","stageRefs","useRef","totalsByStage","setTotalsByStage","canWrite","canDeleteStage","loadDoc","data","getDocumentWithStages","stageIds","s","prev","valid","next","filtered","token","acquireEditSession","id_","__vitePreload","heartbeatEditSession","releaseEditSession","handleAddStage","stage","createStage","handleStageExpand","stageId","handleStageCollapse","handleRenameStage","updateStage","handleDuplicateStage","duplicateStage","loadHistory","h","getSheetHistory","handleExport","blob","exportEstimateXlsx","url","a","handleDeleteStage","deleteStage","jsx","Box","Typography","Button","ArrowBackIcon","jsxs","Tooltip","FormControlLabel","Switch","_","DownloadIcon","IconButton","HistoryIcon","Collapse","item","agg","t","totalSum","totalCost","totalProfit","marginPct","SumRow","label","value","Fragment","formatUaMoney","formatPercent","AddIcon","el","StageAccordion","works","materials","Dialog","DialogTitle","DialogContent","TextField","DialogActions","StageTotalsBlock","worksTotals","materialsTotals","stageSum","stageCost","stageProfit","SumItem","expanded","onExpand","onCollapse","activeTab","onTabChange","canEdit","canDelete","onRenameClick","onDuplicateClick","isDuplicating","onDeleteClick","onTotalsChange","sheetType","buildDocKey","configWithAutocomplete","worksSheetConfig","materialsSheetConfig","adapter","setWorksTotals","React","setMaterialsTotals","handleTotalsChange","Accordion","isExp","AccordionSummary","ExpandLessIcon","ExpandMoreIcon","EditIcon","ContentCopyIcon","DeleteIcon","AccordionDetails","Tabs","Tab","Sheet","W_COL","M_COL"],"ignoreList":[],"sources":["../../src/sheet/hooks/useStageSheetAdapter.ts","../../src/shared/debug/navDebug.ts","../../src/pages/estimate/EstimateEditorPage.tsx"],"sourcesContent":["/**\r\n * Stage sheet adapter. Load/save sheet by docKey (estimate:id:stage:stageId:works|materials).\r\n * REST only — no collab for staged estimates (phase 1).\r\n */\r\n\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport { getSheetByDocKey, saveSheetByDocKey } from '../../api/estimates';\r\nimport type { SheetSnapshot } from '../engine/types';\r\n\r\nexport type StageAdapterMode = 'loading' | 'edit' | 'readonly';\r\n\r\nexport function useStageSheetAdapter(\r\n  estimateId: number | null,\r\n  docKey: string | null,\r\n) {\r\n  const [mode, setMode] = useState<StageAdapterMode>('loading');\r\n  const [initialSnapshot, setInitialSnapshot] = useState<SheetSnapshot | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!estimateId || !docKey) {\r\n      setMode('edit');\r\n      setInitialSnapshot(null);\r\n      return;\r\n    }\r\n\r\n    let mounted = true;\r\n\r\n    (async () => {\r\n      try {\r\n        const { snapshot } = await getSheetByDocKey(estimateId, docKey);\r\n        if (mounted && snapshot) {\r\n          setInitialSnapshot(snapshot as SheetSnapshot);\r\n        }\r\n        if (mounted) setMode('edit');\r\n      } catch {\r\n        if (mounted) setMode('edit');\r\n        setInitialSnapshot(null);\r\n      }\r\n    })();\r\n\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, [estimateId, docKey]);\r\n\r\n  const adapter = {\r\n    getDraftKey: () => (docKey ? `stage:${docKey}` : null),\r\n\r\n    loadSnapshot: async () => {\r\n      if (!estimateId || !docKey) return null;\r\n      const { snapshot, revision } = await getSheetByDocKey(estimateId, docKey);\r\n      return { snapshot: snapshot as SheetSnapshot, revision };\r\n    },\r\n\r\n    saveSnapshot: async (\r\n      snapshot: SheetSnapshot,\r\n      expectedRevision?: number,\r\n    ): Promise<{ revision?: number }> => {\r\n      if (!estimateId || !docKey) throw new Error('No estimate or docKey');\r\n      try {\r\n        const { revision } = await saveSheetByDocKey(\r\n          estimateId,\r\n          docKey,\r\n          snapshot,\r\n          expectedRevision,\r\n        );\r\n        return { revision };\r\n      } catch (e: any) {\r\n        if (e?.response?.status === 409) throw new Error('CONFLICT');\r\n        throw e;\r\n      }\r\n    },\r\n  };\r\n\r\n  return { adapter, mode, initialSnapshot };\r\n}\r\n","import { DEBUG_NAV } from '../config/env';\r\n\r\ntype Off = () => void;\r\n\r\nexport function enableClickDebug(): Off {\r\n  if (!DEBUG_NAV) return () => {};\r\n\r\n  const mark = (e: any, phase: string) => {\r\n    const path = (e.composedPath?.() || [])\r\n      .slice(0, 6)\r\n      .map((n: any) => n?.tagName || n?.nodeName)\r\n      .join('>');\r\n    console.log(`[${phase}] ${e.type}`, {\r\n      target: e.target?.tagName,\r\n      defaultPrevented: e.defaultPrevented,\r\n      cancelBubble: e.cancelBubble,\r\n      path,\r\n    });\r\n  };\r\n\r\n  const cap = (e: any) => mark(e, 'CAPTURE');\r\n  const bub = (e: any) => mark(e, 'BUBBLE');\r\n\r\n  document.addEventListener('click', cap, true);\r\n  document.addEventListener('click', bub, false);\r\n  document.addEventListener('pointerdown', cap, true);\r\n  document.addEventListener('pointerdown', bub, false);\r\n\r\n  console.log('[dbg] click debug ON');\r\n\r\n  return () => {\r\n    document.removeEventListener('click', cap, true);\r\n    document.removeEventListener('click', bub, false);\r\n    document.removeEventListener('pointerdown', cap, true);\r\n    document.removeEventListener('pointerdown', bub, false);\r\n    console.log('[dbg] click debug OFF');\r\n  };\r\n}\r\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { useNavigate, useParams, useLocation } from 'react-router-dom';\r\nimport {\r\n  Accordion,\r\n  AccordionDetails,\r\n  AccordionSummary,\r\n  Box,\r\n  Button,\r\n  Collapse,\r\n  Dialog,\r\n  DialogActions,\r\n  DialogContent,\r\n  DialogTitle,\r\n  FormControlLabel,\r\n  IconButton,\r\n  Switch,\r\n  Tab,\r\n  Tabs,\r\n  TextField,\r\n  Tooltip,\r\n  Typography,\r\n} from '@mui/material';\r\nimport ArrowBackIcon from '@mui/icons-material/ArrowBack';\r\nimport HistoryIcon from '@mui/icons-material/History';\r\nimport ExpandMoreIcon from '@mui/icons-material/ExpandMore';\r\nimport ExpandLessIcon from '@mui/icons-material/ExpandLess';\r\nimport AddIcon from '@mui/icons-material/Add';\r\nimport EditIcon from '@mui/icons-material/Edit';\r\nimport ContentCopyIcon from '@mui/icons-material/ContentCopy';\r\nimport DeleteIcon from '@mui/icons-material/Delete';\r\nimport DownloadIcon from '@mui/icons-material/Download';\r\nimport { Sheet, formatUaMoney, formatPercent, type SheetTotals } from '../../sheet';\r\nimport { worksSheetConfig } from '../../sheet/configs/worksSheetConfig';\r\nimport { materialsSheetConfig } from '../../sheet/configs/materialsSheetConfig';\r\nimport { W_COL } from '../../sheet/configs/worksSheetConfig';\r\nimport { M_COL } from '../../sheet/configs/materialsSheetConfig';\r\nimport { useStageSheetAdapter } from '../../sheet/hooks/useStageSheetAdapter';\r\nimport { useAuth } from '../../modules/auth/AuthContext';\r\nimport {\r\n  getDocumentWithStages,\r\n  createStage,\r\n  updateStage,\r\n  deleteStage,\r\n  duplicateStage,\r\n  exportEstimateXlsx,\r\n  buildDocKey,\r\n  type EstimateStage,\r\n} from '../../api/estimates';\r\nimport { acquireEditSession, releaseEditSession, getSheetHistory } from '../../api/documents';\r\nimport { lsGetJson, lsSetJson } from '../../shared/localStorageJson';\r\nimport { DEBUG_NAV } from '../../shared/config/env';\r\nimport { enableClickDebug } from '../../shared/debug/navDebug';\r\n\r\nconst HEARTBEAT_INTERVAL_MS = 25000;\r\nconst ESTIMATE_LOCK_COLUMNS = true;\r\n/** Дозволити додавати колонки зліва/справа через ПКМ (без видалення/перейменування) */\r\nconst ESTIMATE_ALLOW_COLUMN_INSERT = true;\r\nconst LS_FOCUS_MODE = (estimateId: number) => `estimate:${estimateId}:focusMode`;\r\nconst LS_EXPANDED_STAGES = (estimateId: number) => `estimate:${estimateId}:expandedStages`;\r\nconst LS_HIDE_COST = (estimateId: number) => `estimate:${estimateId}:hideCost`;\r\n\r\nexport const EstimateEditorPage: React.FC = () => {\r\n  const { id } = useParams<{ id: string }>();\r\n  const navigate = useNavigate();\r\n  const loc = useLocation();\r\n  useEffect(() => {\r\n    if (!DEBUG_NAV) return;\r\n    console.log('[EDIT] mount');\r\n    return () => console.log('[EDIT] unmount');\r\n  }, []);\r\n  useEffect(() => {\r\n    if (!DEBUG_NAV) return;\r\n    console.log('[EDIT] location:', loc.pathname, 'key:', (loc as any).key);\r\n  }, [loc.pathname, (loc as any).key]);\r\n  useEffect(() => {\r\n    if (!DEBUG_NAV) return;\r\n    const off = enableClickDebug();\r\n    return () => off();\r\n  }, []);\r\n  const goBack = () => {\r\n    const target = (loc.state as { from?: string })?.from || '/estimate';\r\n    window.location.href = target;\r\n  };\r\n  const { can } = useAuth();\r\n  const estimateId = id ? parseInt(id, 10) : NaN;\r\n  const validId = Number.isFinite(estimateId) && estimateId > 0 ? estimateId : null;\r\n\r\n  const [doc, setDoc] = useState<Awaited<ReturnType<typeof getDocumentWithStages>> | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [focusMode, setFocusModeState] = useState<boolean>(true);\r\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(() => new Set());\r\n  const [viewMode, setViewMode] = useState(false);\r\n  const [hideCost, setHideCostState] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!validId) return;\r\n    setFocusModeState(lsGetJson(LS_FOCUS_MODE(validId), true));\r\n    setHideCostState(lsGetJson(LS_HIDE_COST(validId), false));\r\n  }, [validId]);\r\n\r\n  const setFocusMode = useCallback(\r\n    (v: boolean) => {\r\n      setFocusModeState(v);\r\n      if (validId) lsSetJson(LS_FOCUS_MODE(validId), v);\r\n    },\r\n    [validId],\r\n  );\r\n  const setHideCost = useCallback(\r\n    (v: boolean) => {\r\n      setHideCostState(v);\r\n      if (validId) lsSetJson(LS_HIDE_COST(validId), v);\r\n    },\r\n    [validId],\r\n  );\r\n  const [activeTabByStage, setActiveTabByStage] = useState<Record<string, number>>({});\r\n  const [renameStageId, setRenameStageId] = useState<string | null>(null);\r\n  const [renameValue, setRenameValue] = useState('');\r\n  const [deleteConfirmStage, setDeleteConfirmStage] = useState<EstimateStage | null>(null);\r\n  const [addingStage, setAddingStage] = useState(false);\r\n  const [duplicatingStageId, setDuplicatingStageId] = useState<string | null>(null);\r\n  const [exporting, setExporting] = useState(false);\r\n  const [historyOpen, setHistoryOpen] = useState(false);\r\n  const [history, setHistory] = useState<Awaited<ReturnType<typeof getSheetHistory>>>([]);\r\n  const stageRefs = useRef<Record<string, HTMLDivElement | null>>({});\r\n  const [totalsByStage, setTotalsByStage] = useState<Record<string, { works: SheetTotals; materials: SheetTotals }>>({});\r\n\r\n  const canWrite = can('estimates:write') || can('documents:write') || can('sheet:write');\r\n  const canDeleteStage = canWrite;\r\n\r\n  const loadDoc = useCallback(async () => {\r\n    if (!validId) return;\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const data = await getDocumentWithStages(validId);\r\n      setDoc(data);\r\n      const stageIds = new Set(data.stages.map((s) => s.id));\r\n      setExpandedStages((prev) => {\r\n        const saved = lsGetJson<string[]>(LS_EXPANDED_STAGES(validId), []);\r\n        const valid = saved.filter((id) => stageIds.has(id));\r\n        let next: Set<string>;\r\n        if (valid.length > 0) next = new Set(valid);\r\n        else if (prev.size > 0) {\r\n          const filtered = [...prev].filter((id) => stageIds.has(id));\r\n          next = filtered.length > 0 ? new Set(filtered) : new Set(data.stages.length > 0 ? [data.stages[0].id] : []);\r\n        } else next = data.stages.length > 0 ? new Set([data.stages[0].id]) : new Set();\r\n        if (validId && next.size > 0) lsSetJson(LS_EXPANDED_STAGES(validId), [...next]);\r\n        return next;\r\n      });\r\n    } catch (e: any) {\r\n      setError(e?.response?.data?.message || 'Помилка завантаження');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [validId]);\r\n\r\n  useEffect(() => {\r\n    if (!validId) {\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    loadDoc();\r\n  }, [validId, loadDoc]);\r\n\r\n  useEffect(() => {\r\n    if (!validId || !canWrite) return;\r\n    let token: string | null = null;\r\n    acquireEditSession(validId)\r\n      .then((s) => {\r\n        token = s.token;\r\n      })\r\n      .catch(() => {});\r\n    const beat = () => {\r\n      if (token) {\r\n        import('../../api/documents').then(({ heartbeatEditSession }) =>\r\n          heartbeatEditSession(validId!, token!).catch(() => {}),\r\n        );\r\n      }\r\n    };\r\n    const id_ = setInterval(beat, HEARTBEAT_INTERVAL_MS);\r\n    return () => {\r\n      clearInterval(id_);\r\n      if (token) releaseEditSession(validId!, token).catch(() => {});\r\n    };\r\n  }, [validId, canWrite]);\r\n\r\n  const handleAddStage = async () => {\r\n    if (!validId) return;\r\n    setAddingStage(true);\r\n    try {\r\n      const stage = await createStage(validId, {\r\n        name: `Етап ${(doc?.stages?.length ?? 0) + 1}`,\r\n      });\r\n      await loadDoc();\r\n      setExpandedStages((prev) => {\r\n        const next = focusMode ? new Set([stage.id]) : new Set([...prev, stage.id]);\r\n        if (validId) lsSetJson(LS_EXPANDED_STAGES(validId), [...next]);\r\n        return next;\r\n      });\r\n      setActiveTabByStage((prev) => ({ ...prev, [stage.id]: 0 }));\r\n    } finally {\r\n      setAddingStage(false);\r\n    }\r\n  };\r\n\r\n  const handleStageExpand = useCallback(\r\n    (stageId: string) => {\r\n      setExpandedStages((prev) => {\r\n        const next = focusMode ? new Set([stageId]) : new Set([...prev, stageId]);\r\n        if (validId) lsSetJson(LS_EXPANDED_STAGES(validId), [...next]);\r\n        return next;\r\n      });\r\n    },\r\n    [focusMode, validId],\r\n  );\r\n\r\n  const handleStageCollapse = useCallback(\r\n    (stageId: string) => {\r\n      setExpandedStages((prev) => {\r\n        const next = new Set(prev);\r\n        next.delete(stageId);\r\n        if (validId) lsSetJson(LS_EXPANDED_STAGES(validId), [...next]);\r\n        return next;\r\n      });\r\n    },\r\n    [validId],\r\n  );\r\n\r\n  const handleRenameStage = async () => {\r\n    if (!validId || !renameStageId || !renameValue.trim()) {\r\n      setRenameStageId(null);\r\n      return;\r\n    }\r\n    try {\r\n      await updateStage(validId, renameStageId, { name: renameValue.trim() });\r\n      await loadDoc();\r\n    } finally {\r\n      setRenameStageId(null);\r\n    }\r\n  };\r\n\r\n  const handleDuplicateStage = async (stageId: string) => {\r\n    if (!validId) return;\r\n    setDuplicatingStageId(stageId);\r\n    try {\r\n      const stage = await duplicateStage(validId, stageId);\r\n      await loadDoc();\r\n      setExpandedStages((prev) => {\r\n        const next = new Set(prev);\r\n        next.add(stage.id);\r\n        if (validId) lsSetJson(LS_EXPANDED_STAGES(validId), [...next]);\r\n        return next;\r\n      });\r\n      setActiveTabByStage((prev) => ({ ...prev, [stage.id]: 0 }));\r\n    } catch {\r\n      // error handled by loadDoc\r\n    } finally {\r\n      setDuplicatingStageId(null);\r\n    }\r\n  };\r\n\r\n  const loadHistory = useCallback(async () => {\r\n    if (!validId) return;\r\n    try {\r\n      const h = await getSheetHistory(validId, 20);\r\n      setHistory(h);\r\n    } catch {\r\n      setHistory([]);\r\n    }\r\n  }, [validId]);\r\n\r\n  useEffect(() => {\r\n    if (historyOpen && validId) loadHistory();\r\n  }, [historyOpen, validId, loadHistory]);\r\n\r\n  const handleExport = useCallback(async () => {\r\n    if (!validId) return;\r\n    setExporting(true);\r\n    try {\r\n      const blob = await exportEstimateXlsx(validId);\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `КП-${validId}.xlsx`;\r\n      a.click();\r\n      URL.revokeObjectURL(url);\r\n    } finally {\r\n      setExporting(false);\r\n    }\r\n  }, [validId]);\r\n\r\n  const handleDeleteStage = async () => {\r\n    if (!validId || !deleteConfirmStage) return;\r\n    try {\r\n      await deleteStage(validId, deleteConfirmStage.id);\r\n      await loadDoc();\r\n      setDeleteConfirmStage(null);\r\n    } finally {\r\n      setDeleteConfirmStage(null);\r\n    }\r\n  };\r\n\r\n  if (!validId) {\r\n    return (\r\n      <Box>\r\n        <Button startIcon={<ArrowBackIcon />} onClick={() => navigate('/estimate')}>\r\n          Назад\r\n        </Button>\r\n        <Typography color=\"error\" sx={{ mt: 2 }}>\r\n          Невірний ідентифікатор\r\n        </Typography>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  if (loading && !doc) {\r\n    return (\r\n      <Box>\r\n        <Typography>Завантаження…</Typography>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  if (error && !doc) {\r\n    return (\r\n      <Box>\r\n        <Button startIcon={<ArrowBackIcon />} onClick={goBack}>\r\n          Назад\r\n        </Button>\r\n        <Typography color=\"error\" sx={{ mt: 2 }}>\r\n          {error}\r\n        </Typography>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Box className=\"estimate-editor-full\" sx={{ width: '100%', maxWidth: '100%' }}>\r\n      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1.5, flexWrap: 'wrap' }}>\r\n        <Button\r\n          size=\"small\"\r\n          startIcon={<ArrowBackIcon />}\r\n          onClick={goBack}\r\n        >\r\n          Назад\r\n        </Button>\r\n        <Typography variant=\"h6\" sx={{ flex: 1 }}>\r\n          {doc?.title ?? `КП #${validId}`}\r\n        </Typography>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, flexWrap: 'wrap' }}>\r\n          {canWrite && (\r\n            <Tooltip title=\"Режим тільки перегляд — без редагування\">\r\n              <FormControlLabel\r\n                control={\r\n                  <Switch\r\n                    size=\"small\"\r\n                    checked={viewMode}\r\n                    onChange={(_, v) => setViewMode(v)}\r\n                    color=\"primary\"\r\n                  />\r\n                }\r\n                label={<Typography sx={{ fontSize: 12 }}>Тільки перегляд</Typography>}\r\n              />\r\n            </Tooltip>\r\n          )}\r\n          <Tooltip title=\"Приховати колонки собівартості\">\r\n            <FormControlLabel\r\n              control={\r\n                <Switch\r\n                  size=\"small\"\r\n                  checked={hideCost}\r\n                  onChange={(_, v) => setHideCost(v)}\r\n                  color=\"primary\"\r\n                />\r\n              }\r\n              label={<Typography sx={{ fontSize: 12 }}>Приховати собівартість</Typography>}\r\n            />\r\n          </Tooltip>\r\n          {doc?.stages && doc.stages.length > 0 && (\r\n            <Tooltip title=\"При відкритті етапу інші згортаються\">\r\n              <FormControlLabel\r\n                control={\r\n                  <Switch\r\n                    size=\"small\"\r\n                    checked={focusMode}\r\n                    onChange={(_, v) => setFocusMode(v)}\r\n                    color=\"primary\"\r\n                  />\r\n                }\r\n                label={\r\n                  <Typography sx={{ fontSize: 12 }}>Фокус етапу</Typography>\r\n                }\r\n              />\r\n            </Tooltip>\r\n          )}\r\n        </Box>\r\n        <Button\r\n          size=\"small\"\r\n          startIcon={<DownloadIcon />}\r\n          onClick={handleExport}\r\n          disabled={exporting || !doc?.stages?.length}\r\n        >\r\n          {exporting ? '…' : 'Експорт XLSX'}\r\n        </Button>\r\n        <Tooltip title={historyOpen ? 'Згорнути історію' : 'Історія змін'}>\r\n          <IconButton size=\"small\" onClick={() => setHistoryOpen((v) => !v)} color={historyOpen ? 'primary' : 'default'}>\r\n            <HistoryIcon fontSize=\"small\" />\r\n          </IconButton>\r\n        </Tooltip>\r\n      </Box>\r\n      <Collapse in={historyOpen}>\r\n        <Box sx={{ mb: 2, p: 1.5, bgcolor: 'action.hover', borderRadius: 1, border: '1px solid', borderColor: 'divider' }}>\r\n          <Typography variant=\"caption\" fontWeight={600} color=\"text.secondary\" sx={{ display: 'block', mb: 1 }}>\r\n            Останні зміни\r\n          </Typography>\r\n          {history.length === 0 ? (\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Історія змін поки відсутня\r\n            </Typography>\r\n          ) : (\r\n            <Box component=\"ul\" sx={{ m: 0, pl: 2.5, fontSize: 13 }}>\r\n              {history.map((item) => (\r\n                <li key={`${item.kind}-${item.id}`}>\r\n                  {item.kind === 'version' ? 'Версія' : 'Оновлення'} #{item.id} ·{' '}\r\n                  {item.createdAt ? new Date(item.createdAt).toLocaleString('uk-UA') : ''}\r\n                  {item.note ? ` · ${item.note}` : ''}\r\n                </li>\r\n              ))}\r\n            </Box>\r\n          )}\r\n        </Box>\r\n      </Collapse>\r\n\r\n      {doc?.stages && doc.stages.length > 0 && (() => {\r\n        const agg = doc.stages.reduce(\r\n          (a, s) => {\r\n            const t = totalsByStage[s.id];\r\n            if (t) {\r\n              a.worksSum += t.works.sum;\r\n              a.worksCost += t.works.cost;\r\n              a.materialsSum += t.materials.sum;\r\n              a.materialsCost += t.materials.cost;\r\n            }\r\n            return a;\r\n          },\r\n          { worksSum: 0, worksCost: 0, materialsSum: 0, materialsCost: 0 },\r\n        );\r\n        const totalSum = agg.worksSum + agg.materialsSum;\r\n        const totalCost = agg.worksCost + agg.materialsCost;\r\n        const totalProfit = totalSum - totalCost;\r\n        const marginPct = totalSum > 0 ? (totalProfit / totalSum) * 100 : 0;\r\n        const SumRow = ({ label, value }: { label: string; value: string }) => (\r\n          <Box sx={{ display: 'flex', alignItems: 'baseline', gap: 0.5 }}>\r\n            <Typography sx={{ fontSize: 11, color: 'text.secondary' }}>{label}:</Typography>\r\n            <Typography sx={{ fontSize: 13, fontWeight: 600 }}>{value}</Typography>\r\n          </Box>\r\n        );\r\n        return (\r\n          <Box\r\n            sx={{\r\n              display: 'flex',\r\n              flexDirection: 'row',\r\n              flexWrap: 'wrap',\r\n              gap: 2,\r\n              p: 0.75,\r\n              mb: 1,\r\n              borderRadius: 1,\r\n              bgcolor: 'action.hover',\r\n              border: '1px solid',\r\n              borderColor: 'divider',\r\n              alignItems: 'center',\r\n            }}\r\n          >\r\n            <Typography sx={{ fontSize: 11, fontWeight: 600, color: 'text.secondary', mr: 0.5 }}>\r\n              Загалом КП\r\n            </Typography>\r\n            {hideCost ? (\r\n              <>\r\n                <SumRow label=\"Сума в роботах\" value={formatUaMoney(agg.worksSum)} />\r\n                <SumRow label=\"Сума в матеріалах\" value={formatUaMoney(agg.materialsSum)} />\r\n                <SumRow label=\"Всього\" value={formatUaMoney(totalSum)} />\r\n              </>\r\n            ) : (\r\n              <>\r\n                <SumRow label=\"Роботи: сума\" value={formatUaMoney(agg.worksSum)} />\r\n                <SumRow label=\"Роботи: собівартість\" value={formatUaMoney(agg.worksCost)} />\r\n                <SumRow label=\"Роботи: прибуток\" value={formatUaMoney(agg.worksSum - agg.worksCost)} />\r\n                <SumRow label=\"Матеріали: сума\" value={formatUaMoney(agg.materialsSum)} />\r\n                <SumRow label=\"Матеріали: собівартість\" value={formatUaMoney(agg.materialsCost)} />\r\n                <SumRow label=\"Матеріали: прибуток\" value={formatUaMoney(agg.materialsSum - agg.materialsCost)} />\r\n                <SumRow label=\"Всього: сума\" value={formatUaMoney(totalSum)} />\r\n                <SumRow label=\"Всього: собівартість\" value={formatUaMoney(totalCost)} />\r\n                <SumRow label=\"Маржа\" value={formatPercent(marginPct)} />\r\n                <SumRow label=\"Прибуток\" value={formatUaMoney(totalProfit)} />\r\n              </>\r\n            )}\r\n          </Box>\r\n        );\r\n      })()}\r\n\r\n      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: 1, mb: 1 }}>\r\n        <Typography variant=\"subtitle2\" color=\"text.secondary\" sx={{ mr: 1 }}>\r\n          Етапи\r\n        </Typography>\r\n        {canWrite && !viewMode && (\r\n          <Button\r\n            size=\"small\"\r\n            startIcon={<AddIcon />}\r\n            onClick={handleAddStage}\r\n            disabled={addingStage}\r\n          >\r\n            Додати етап\r\n          </Button>\r\n        )}\r\n      </Box>\r\n\r\n      {doc?.stages?.length === 0 ? (\r\n        <Box sx={{ py: 3, textAlign: 'center' }}>\r\n          <Typography color=\"text.secondary\" sx={{ mb: 2 }}>\r\n            Немає етапів. Додайте перший етап.\r\n          </Typography>\r\n          {canWrite && (\r\n            <Button\r\n              variant=\"contained\"\r\n              startIcon={<AddIcon />}\r\n              onClick={handleAddStage}\r\n              disabled={addingStage}\r\n            >\r\n              Додати етап\r\n            </Button>\r\n          )}\r\n        </Box>\r\n      ) : (\r\n        doc?.stages?.map((stage) => (\r\n          <Box\r\n            key={stage.id}\r\n            ref={(el) => {\r\n              if (el) stageRefs.current[stage.id] = el;\r\n              else delete stageRefs.current[stage.id];\r\n            }}\r\n          >\r\n            <StageAccordion\r\n              stage={stage}\r\n              estimateId={validId!}\r\n              expanded={expandedStages.has(stage.id)}\r\n              onExpand={() => handleStageExpand(stage.id)}\r\n              onCollapse={() => handleStageCollapse(stage.id)}\r\n              activeTab={activeTabByStage[stage.id] ?? 0}\r\n              onTabChange={(v) =>\r\n                setActiveTabByStage((prev) => ({ ...prev, [stage.id]: v }))\r\n              }\r\n              canEdit={!viewMode && canWrite}\r\n              canDelete={canDeleteStage && !viewMode}\r\n              hideCost={hideCost}\r\n              onRenameClick={() => {\r\n                setRenameStageId(stage.id);\r\n                setRenameValue(stage.name);\r\n              }}\r\n              onDuplicateClick={() => handleDuplicateStage(stage.id)}\r\n              isDuplicating={duplicatingStageId === stage.id}\r\n              onDeleteClick={() => setDeleteConfirmStage(stage)}\r\n              onTotalsChange={(works, materials) =>\r\n                setTotalsByStage((prev) => ({ ...prev, [stage.id]: { works, materials } }))\r\n              }\r\n            />\r\n          </Box>\r\n        ))\r\n      )}\r\n\r\n      <Dialog open={!!renameStageId} onClose={() => setRenameStageId(null)}>\r\n        <DialogTitle>Перейменувати етап</DialogTitle>\r\n        <DialogContent>\r\n          <TextField\r\n            autoFocus\r\n            fullWidth\r\n            value={renameValue}\r\n            onChange={(e) => setRenameValue(e.target.value)}\r\n            onKeyDown={(e) => {\r\n              if (e.key === 'Enter') handleRenameStage();\r\n              if (e.key === 'Escape') setRenameStageId(null);\r\n            }}\r\n          />\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={() => setRenameStageId(null)}>Скасувати</Button>\r\n          <Button variant=\"contained\" onClick={handleRenameStage} disabled={!renameValue.trim()}>\r\n            Зберегти\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n\r\n      <Dialog open={!!deleteConfirmStage} onClose={() => setDeleteConfirmStage(null)}>\r\n        <DialogTitle>Видалити етап</DialogTitle>\r\n        <DialogContent>\r\n          <Typography>\r\n            Видалити етап &quot;{deleteConfirmStage?.name}&quot;? Дані робіт і матеріалів\r\n            будуть втрачені.\r\n          </Typography>\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={() => setDeleteConfirmStage(null)}>Скасувати</Button>\r\n          <Button color=\"error\" variant=\"contained\" onClick={handleDeleteStage}>\r\n            Видалити\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n    </Box>\r\n  );\r\n};\r\n\r\nfunction StageTotalsBlock({\r\n  worksTotals,\r\n  materialsTotals,\r\n  hideCost = false,\r\n}: {\r\n  worksTotals: SheetTotals;\r\n  materialsTotals: SheetTotals;\r\n  hideCost?: boolean;\r\n}) {\r\n  const stageSum = worksTotals.sum + materialsTotals.sum;\r\n  const stageCost = worksTotals.cost + materialsTotals.cost;\r\n  const stageProfit = stageSum - stageCost;\r\n  const marginPct = stageSum > 0 ? (stageProfit / stageSum) * 100 : 0;\r\n  const SumItem = ({ label, value }: { label: string; value: string }) => (\r\n    <Box sx={{ display: 'flex', gap: 0.5, fontSize: 12 }}>\r\n      <span style={{ color: 'var(--mui-palette-text-secondary)' }}>{label}:</span>\r\n      <span style={{ fontWeight: 600 }}>{value}</span>\r\n    </Box>\r\n  );\r\n  return (\r\n    <Box\r\n      sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        alignItems: 'flex-end',\r\n        gap: 0.25,\r\n        px: 1.5,\r\n        py: 0.75,\r\n        fontSize: 12,\r\n        bgcolor: 'action.hover',\r\n        borderRadius: 1,\r\n        border: '1px solid',\r\n        borderColor: 'divider',\r\n      }}\r\n    >\r\n      {hideCost ? (\r\n        <>\r\n          <SumItem label=\"Роботи\" value={formatUaMoney(worksTotals.sum)} />\r\n          <SumItem label=\"Матеріали\" value={formatUaMoney(materialsTotals.sum)} />\r\n          <SumItem label=\"Етап\" value={formatUaMoney(stageSum)} />\r\n        </>\r\n      ) : (\r\n        <>\r\n          <SumItem label=\"Роботи\" value={`${formatUaMoney(worksTotals.sum)} / соб. ${formatUaMoney(worksTotals.cost)}`} />\r\n          <SumItem label=\"Матеріали\" value={`${formatUaMoney(materialsTotals.sum)} / соб. ${formatUaMoney(materialsTotals.cost)}`} />\r\n          <SumItem label=\"Етап\" value={`${formatUaMoney(stageSum)} · маржа ${formatPercent(marginPct)}`} />\r\n        </>\r\n      )}\r\n    </Box>\r\n  );\r\n}\r\n\r\ntype StageAccordionProps = {\r\n  stage: EstimateStage;\r\n  estimateId: number;\r\n  expanded: boolean;\r\n  onExpand: () => void;\r\n  onCollapse: () => void;\r\n  activeTab: number;\r\n  onTabChange: (v: number) => void;\r\n  canEdit: boolean;\r\n  canDelete: boolean;\r\n  hideCost: boolean;\r\n  onRenameClick: () => void;\r\n  onDuplicateClick: () => void;\r\n  isDuplicating?: boolean;\r\n  onDeleteClick: () => void;\r\n  onTotalsChange?: (works: SheetTotals, materials: SheetTotals) => void;\r\n};\r\n\r\nfunction StageAccordion({\r\n  stage,\r\n  estimateId,\r\n  expanded,\r\n  onExpand,\r\n  onCollapse,\r\n  activeTab,\r\n  onTabChange,\r\n  canEdit,\r\n  canDelete,\r\n  hideCost,\r\n  onRenameClick,\r\n  onDuplicateClick,\r\n  isDuplicating = false,\r\n  onDeleteClick,\r\n  onTotalsChange,\r\n}: StageAccordionProps) {\r\n  const sheetType = activeTab === 0 ? 'works' : 'materials';\r\n  const docKey = buildDocKey(estimateId, stage.id, sheetType);\r\n  const baseConfig = activeTab === 0 ? worksSheetConfig : materialsSheetConfig;\r\n  const config = ESTIMATE_LOCK_COLUMNS\r\n    ? {\r\n        ...baseConfig,\r\n        allowColumnInsert: ESTIMATE_ALLOW_COLUMN_INSERT,\r\n        allowColumnDelete: false,\r\n        allowColumnRename: false,\r\n      }\r\n    : baseConfig;\r\n  const configWithAutocomplete = {\r\n    ...config,\r\n    autocompleteForColumn: { colIndex: 1, type: sheetType },\r\n    hiddenColumns: hideCost ? [6, 7] : undefined,\r\n    allowCellComments: true,\r\n    allowFreeze: true,\r\n  };\r\n  const { adapter, initialSnapshot } = useStageSheetAdapter(estimateId, docKey);\r\n  const [worksTotals, setWorksTotals] = React.useState<SheetTotals>({ sum: 0, cost: 0, profit: 0 });\r\n  const [materialsTotals, setMaterialsTotals] = React.useState<SheetTotals>({ sum: 0, cost: 0, profit: 0 });\r\n\r\n  React.useEffect(() => {\r\n    onTotalsChange?.(worksTotals, materialsTotals);\r\n  }, [worksTotals, materialsTotals, onTotalsChange]);\r\n\r\n  const handleTotalsChange = React.useCallback((t: SheetTotals) => {\r\n    if (sheetType === 'works') setWorksTotals(t);\r\n    else setMaterialsTotals(t);\r\n  }, [sheetType]);\r\n\r\n  return (\r\n    <Accordion\r\n      expanded={expanded}\r\n      onChange={(_, isExp) => (isExp ? onExpand() : onCollapse())}\r\n      sx={{\r\n        '&:before': { display: 'none' },\r\n        boxShadow: 0,\r\n        border: '1px solid',\r\n        borderColor: 'divider',\r\n        mb: 0.5,\r\n      }}\r\n    >\r\n      <AccordionSummary\r\n        expandIcon={expanded ? <ExpandLessIcon /> : <ExpandMoreIcon />}\r\n        sx={{ minHeight: 44, '& .MuiAccordionSummary-content': { my: 0.5 } }}\r\n      >\r\n        <Box\r\n          sx={{ display: 'flex', alignItems: 'center', gap: 1, flex: 1 }}\r\n          onClick={(e) => e.stopPropagation()}\r\n        >\r\n          <Typography variant=\"body2\" fontWeight={600}>\r\n            {stage.name}\r\n          </Typography>\r\n          {canEdit && (\r\n            <IconButton size=\"small\" onClick={(e) => { e.stopPropagation(); onRenameClick(); }} aria-label=\"Перейменувати\">\r\n              <EditIcon fontSize=\"small\" />\r\n            </IconButton>\r\n          )}\r\n          {canEdit && (\r\n            <IconButton\r\n              size=\"small\"\r\n              onClick={(e) => { e.stopPropagation(); onDuplicateClick(); }}\r\n              aria-label=\"Дублювати\"\r\n              disabled={isDuplicating}\r\n            >\r\n              <ContentCopyIcon fontSize=\"small\" />\r\n            </IconButton>\r\n          )}\r\n          {canDelete && (\r\n            <IconButton\r\n              size=\"small\"\r\n              color=\"error\"\r\n              onClick={(e) => {\r\n                e.stopPropagation();\r\n                onDeleteClick();\r\n              }}\r\n              aria-label=\"Видалити\"\r\n            >\r\n              <DeleteIcon fontSize=\"small\" />\r\n            </IconButton>\r\n          )}\r\n        </Box>\r\n      </AccordionSummary>\r\n      <AccordionDetails sx={{ pt: 0, px: 0 }}>\r\n        <Tabs\r\n          value={activeTab}\r\n          onChange={(_, v) => onTabChange(v)}\r\n          sx={{ minHeight: 36, borderBottom: 1, borderColor: 'divider', px: 1 }}\r\n        >\r\n          <Tab label=\"Роботи\" sx={{ minHeight: 36, py: 0.5 }} />\r\n          <Tab label=\"Матеріали\" sx={{ minHeight: 36, py: 0.5 }} />\r\n        </Tabs>\r\n        <Box sx={{ pt: 0.5, position: 'relative' }}>\r\n          <Sheet\r\n            config={configWithAutocomplete}\r\n            adapter={adapter ?? undefined}\r\n            documentId={null}\r\n            initialSnapshot={initialSnapshot}\r\n            readonly={!canEdit}\r\n            totalsConfig={sheetType === 'works' ? { sumCol: W_COL.TOTAL, costCol: W_COL.COST_TOTAL } : { sumCol: M_COL.TOTAL, costCol: M_COL.COST_TOTAL }}\r\n            onTotalsChange={handleTotalsChange}\r\n          />\r\n          <Box sx={{ display: 'flex', justifyContent: 'flex-end', mt: 0.5 }}>\r\n            <StageTotalsBlock\r\n              worksTotals={worksTotals}\r\n              materialsTotals={materialsTotals}\r\n              hideCost={hideCost}\r\n            />\r\n          </Box>\r\n        </Box>\r\n      </AccordionDetails>\r\n    </Accordion>\r\n  );\r\n}\r\n"],"file":"EstimateEditorPage-CJPyDOIn.js"}