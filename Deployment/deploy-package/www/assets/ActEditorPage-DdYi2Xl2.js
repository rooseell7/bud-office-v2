import{r as l,g as K,n as dt,u as ut,a as xt,b as pt,o as ft,p as J,q as M,j as t,B as m,c as L,A as O,T as x,C as G,s as Q,F as X,S as Y,f as b,d as ht,R as P,t as mt}from"./index-D9d13f7b.js";import{A as yt,a as St,E as gt,b as wt,c as jt}from"./ExpandLess-W-_vDl4v.js";import{W as j,a as Ct}from"./worksSheetConfig-BsCs0GIO.js";function A(s){if(s==null)return 0;const o=Number(s);return Number.isFinite(o)?o:0}function Z(s,o){const r=[];for(const n of s)(n?.rowType??n?.type)==="work"&&(n?.sectionKey===o||!o)&&r.push(n);return r}const Tt=20;function tt(s){const o=Math.max(s.length,Tt),r=9,n=[];for(let i=0;i<o;i++){const a=s[i];n[i]=["",String(a?.name??a?.title??""),String(a?.unit??""),String(A(a?.qty)),String(A(a?.price)),"",String(A(a?.costPrice??a?.cost)),"",String(a?.note??"")]}return{rawValues:n,values:n.map(i=>[...i]),rowCount:o,colCount:r}}function kt(s,o){const r=s.rawValues??s.values??[],n=Math.max(s.rowCount??r.length,r.length),i=[];for(let a=0;a<n;a++){const e=r[a],p=e?String(e[j.NAME]??"").trim():"",S=e?String(e[j.UNIT]??"").trim():"",u=e?A(e[j.QTY]):0,y=e?A(e[j.PRICE]):0,C=e?A(e[j.COST_UNIT]):0,g=e?String(e[j.NOTE]??"").trim():"";i.push({rowType:"work",type:"work",sectionKey:o,name:p||"",unit:S||"",qty:u,price:y,costPrice:C,note:g||void 0})}return i.length===0&&i.push({rowType:"work",type:"work",sectionKey:o,name:"",unit:"",qty:0,price:0,costPrice:0}),i}function bt(s,o,r){const n=[];let i=!1;for(const e of s){const p=e?.rowType??e?.type,S=e?.sectionKey;if(p==="meta"){n.push(e),i=!1;continue}if(p==="section"){i=S===o,n.push(e),i&&n.push(...r);continue}i&&S===o&&p==="work"||n.push(e)}return s.some(e=>(e?.rowType??e?.type)==="section"&&e?.sectionKey===o)||n.push({rowType:"section",type:"section",sectionKey:o,title:"Роботи"},...r),n}function At(s,o,r,n){const[i,a]=l.useState("loading"),[e,p]=l.useState(null);return l.useEffect(()=>{if(!s||!o){a("edit"),p(null);return}const u=Z(r,o);p(tt(u)),a("edit")},[s,o,JSON.stringify(r.map(u=>({sk:u?.sectionKey,t:u?.rowType??u?.type})))]),{adapter:{getDraftKey:()=>s&&o?`act:${s}:${o}`:null,loadSnapshot:async()=>{if(!s)return null;const u=await K(s),y=Z(u.items??[],o);return{snapshot:tt(y),revision:0}},saveSnapshot:async u=>{if(!s||!o)throw new Error("No act or sectionKey");const y=await K(s),C=y.items??[],g=kt(u,o),w=bt(C,o,g).map(T=>{const d={...T};return typeof d.rowType=="string"&&(d.type=d.rowType),d.rowType==="work"&&(d.title=d.name,d.cost=d.costPrice),d.rowType==="percent"&&(d.title=d.name,d.percent=d.percentValue),d});return await dt(s,{projectId:y.projectId,foremanId:y.foremanId,actDate:y.actDate,status:y.status,items:w}),n?.(),{revision:0}}},mode:i,initialSnapshot:e}}const It=!0,et=s=>`act:${s}:hideCost`,D=s=>`act:${s}:expandedSections`;function vt(s){const r=[...Array.isArray(s)?s:[]];r.some(e=>e?.rowType==="meta"||e?.type==="meta")||r.unshift({rowType:"meta",type:"meta",header:{}});const i=r.some(e=>e?.rowType==="section"||e?.type==="section"),a=r.some(e=>e?.rowType==="work"||e?.type==="work");return i||r.push({rowType:"section",type:"section",sectionKey:"sec_1",title:"Роботи"}),a||r.push({rowType:"work",type:"work",sectionKey:"sec_1",name:"",unit:"",qty:0,price:0,costPrice:0}),r}function st(s){const o=new Set,r=[];for(const n of s)(n?.rowType??n?.type)==="section"&&n?.sectionKey&&!o.has(n.sectionKey)&&(o.add(n.sectionKey),r.push({sectionKey:n.sectionKey,title:String(n?.title??"Роботи")}));return r.length===0&&r.push({sectionKey:"sec_1",title:"Роботи"}),r}const Lt=()=>{const{id:s}=ut(),o=xt(),r=pt(),n=l.useCallback(()=>{const c=r.state?.from||"/estimate/acts";window.location.href=c},[r.state]),{can:i}=ft(),a=s?parseInt(s,10):NaN,e=Number.isFinite(a)&&a>0?a:null,[p,S]=l.useState(null),[u,y]=l.useState([]),[C,g]=l.useState(!0),[I,w]=l.useState(null),[T,d]=l.useState(!1),[z,v]=l.useState(()=>new Set),[R,ot]=l.useState(!1),[F,nt]=l.useState({}),B=i("delivery:write")||i("estimates:write");l.useEffect(()=>{e&&d(J(et(e),!1))},[e]);const rt=l.useCallback(c=>{d(c),e&&M(et(e),c)},[e]),W=l.useCallback(async()=>{if(e){g(!0),w(null);try{const c=await K(e);S(c);const h=vt(c.items);y(h);const f=st(h);v(H=>{const V=J(D(e),[]).filter(k=>f.some(E=>E.sectionKey===k));if(V.length>0)return new Set(V);if(H.size>0){const k=[...H].filter(E=>f.some(lt=>lt.sectionKey===E));return k.length>0?new Set(k):new Set(f.map(E=>E.sectionKey))}return new Set(f.slice(0,1).map(k=>k.sectionKey))})}catch(c){w(c?.message||"Помилка завантаження")}finally{g(!1)}}},[e]);l.useEffect(()=>{if(!e){g(!1);return}W()},[e,W]);const it=l.useCallback(c=>{v(h=>{const f=new Set(h);return f.add(c),e&&M(D(e),[...f]),f})},[e]),ct=l.useCallback(c=>{v(h=>{const f=new Set(h);return f.delete(c),e&&M(D(e),[...f]),f})},[e]),U=l.useMemo(()=>st(u),[u]),_=l.useMemo(()=>{let c=0,h=0;for(const f of Object.values(F))c+=f.sum,h+=f.cost;return{worksSum:c,worksCost:h}},[F]);if(!e)return t.jsxs(m,{children:[t.jsx(L,{startIcon:t.jsx(O,{}),onClick:()=>o("/estimate/acts"),children:"Назад"}),t.jsx(x,{color:"error",sx:{mt:2},children:"Невірний ідентифікатор"})]});if(C&&!p)return t.jsx(m,{children:t.jsx(x,{children:"Завантаження…"})});if(I&&!p)return t.jsxs(m,{children:[t.jsx(L,{startIcon:t.jsx(O,{}),onClick:n,children:"Назад"}),t.jsx(x,{color:"error",sx:{mt:2},children:I})]});if(!p)return null;const N=_.worksSum,q=_.worksCost,$=N-q,at=N>0?$/N*100:0;return t.jsxs(m,{className:"act-editor-full",sx:{width:"100%",maxWidth:"100%"},children:[t.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1,mb:1.5,flexWrap:"wrap"},children:[t.jsx(L,{size:"small",startIcon:t.jsx(O,{}),onClick:n,children:"Назад"}),t.jsxs(x,{variant:"h6",sx:{flex:1},children:["Акт №",p.id]}),t.jsx(G,{size:"small",label:`Дата: ${p.actDate}`}),t.jsx(G,{size:"small",label:p.status}),B&&t.jsx(Q,{title:"Режим тільки перегляд",children:t.jsx(X,{control:t.jsx(Y,{size:"small",checked:R,onChange:(c,h)=>ot(h),color:"primary"}),label:t.jsx(x,{sx:{fontSize:12},children:"Тільки перегляд"})})}),t.jsx(Q,{title:"Приховати колонки собівартості",children:t.jsx(X,{control:t.jsx(Y,{size:"small",checked:T,onChange:(c,h)=>rt(h),color:"primary"}),label:t.jsx(x,{sx:{fontSize:12},children:"Приховати собівартість"})})})]}),t.jsxs(m,{sx:{display:"flex",flexWrap:"wrap",gap:2,p:.75,mb:1,borderRadius:1,bgcolor:"action.hover",border:"1px solid",borderColor:"divider",alignItems:"center"},children:[t.jsx(x,{sx:{fontSize:11,fontWeight:600,color:"text.secondary",mr:.5},children:"Загалом по акту"}),t.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[t.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Роботи:"}),t.jsx(x,{sx:{fontSize:13,fontWeight:600},children:b(_.worksSum)})]}),!T&&t.jsxs(t.Fragment,{children:[t.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[t.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Собівартість:"}),t.jsx(x,{sx:{fontSize:13,fontWeight:600},children:b(q)})]}),t.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[t.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Маржа:"}),t.jsx(x,{sx:{fontSize:13,fontWeight:600},children:ht(at)})]}),t.jsxs(m,{sx:{display:"flex",alignItems:"baseline",gap:.5},children:[t.jsx(x,{sx:{fontSize:11,color:"text.secondary"},children:"Прибуток:"}),t.jsx(x,{sx:{fontSize:13,fontWeight:600},children:b($)})]})]})]}),t.jsx(x,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Секції (роботи)"}),U.length===0?t.jsx(x,{color:"text.secondary",children:"Немає секцій"}):U.map(c=>t.jsx(Et,{section:c,actId:e,items:u,onItemsRefresh:()=>W(),expanded:z.has(c.sectionKey),onExpand:()=>it(c.sectionKey),onCollapse:()=>ct(c.sectionKey),canEdit:!R&&B,hideCost:T,onTotalsChange:h=>nt(f=>({...f,[c.sectionKey]:h}))},c.sectionKey))]})};function Et({section:s,actId:o,items:r,onItemsRefresh:n,expanded:i,onExpand:a,onCollapse:e,canEdit:p,hideCost:S,onTotalsChange:u}){const C={...{...Ct,allowColumnInsert:It,allowColumnDelete:!1,allowColumnRename:!1},autocompleteForColumn:{colIndex:1,type:"works"},hiddenColumns:S?[6,7]:void 0,allowCellComments:!0,allowFreeze:!0},{adapter:g,initialSnapshot:I}=At(o,s.sectionKey,r,n??void 0),[w,T]=P.useState({sum:0,cost:0,profit:0});P.useEffect(()=>{u(w)},[w,u]);const d=P.useCallback(z=>{T(z)},[]);return t.jsxs(yt,{expanded:i,onChange:(z,v)=>v?a():e(),sx:{"&:before":{display:"none"},boxShadow:0,border:"1px solid",borderColor:"divider",mb:.5},children:[t.jsx(St,{expandIcon:i?t.jsx(gt,{}):t.jsx(wt,{}),sx:{minHeight:44,"& .MuiAccordionSummary-content":{my:.5}},children:t.jsx(x,{variant:"body2",fontWeight:600,children:s.title})}),t.jsx(jt,{sx:{pt:0,px:0},children:t.jsxs(m,{sx:{pt:.5,position:"relative"},children:[t.jsx(mt,{config:C,adapter:g??void 0,documentId:null,initialSnapshot:I,readonly:!p,totalsConfig:{sumCol:j.TOTAL,costCol:j.COST_TOTAL},onTotalsChange:d}),t.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:.5},children:t.jsx(zt,{totals:w,hideCost:S})})]})})]})}function zt({totals:s,hideCost:o}){return t.jsx(m,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:.25,px:1.5,py:.75,fontSize:12,bgcolor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider"},children:o?t.jsxs("span",{children:[t.jsx("span",{style:{color:"var(--mui-palette-text-secondary)"},children:"Роботи:"})," ",t.jsx("strong",{children:b(s.sum)})]}):t.jsx(t.Fragment,{children:t.jsxs("span",{children:[t.jsx("span",{style:{color:"var(--mui-palette-text-secondary)"},children:"Роботи:"})," ",t.jsxs("strong",{children:[b(s.sum)," / соб. ",b(s.cost)]})]})})})}export{Lt as ActEditorPage};
//# sourceMappingURL=ActEditorPage-DdYi2Xl2.js.map
